# é«˜å°”å¤«è§†é¢‘ä¸‹è½½ API - å¿«é€Ÿéƒ¨ç½²

## ğŸ¯ ç›®æ ‡
ä½¿ç”¨ CloudFlare Tunnel + Docker Desktop éƒ¨ç½²è§†é¢‘ä¸‹è½½æœåŠ¡ï¼Œä¾›é«˜å°”å¤« App è°ƒç”¨

---

## ğŸ“‹ å‰ç½®è¦æ±‚

1. âœ… Docker Desktop å·²å®‰è£…å¹¶è¿è¡Œï¼ˆWindowsï¼‰
2. âœ… CloudFlare è´¦å·ï¼ˆå…è´¹ï¼‰
3. âœ… æ‹¥æœ‰ä¸€ä¸ªåŸŸåï¼ˆå·²æ·»åŠ åˆ° CloudFlareï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»º CloudFlare Tunnel

1. è®¿é—® [CloudFlare Zero Trust](https://one.dash.cloudflare.com/)
2. å·¦ä¾§èœå•ï¼š**Access** â†’ **Tunnels**
3. ç‚¹å‡» **Create a tunnel**
4. è¾“å…¥åç§°ï¼š`golf-video-api`
5. ç‚¹å‡» **Save tunnel**
6. **å¤åˆ¶æ˜¾ç¤ºçš„ Token**ï¼ˆé‡è¦ï¼ï¼‰

### æ­¥éª¤ 2ï¼šé…ç½® Public Hostname

åœ¨ Tunnel é…ç½®é¡µé¢ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| Subdomain | `golf-video-api` (æˆ–è‡ªå®šä¹‰) |
| Domain | é€‰æ‹©ä½ çš„åŸŸå |
| Type | HTTP |
| URL | `video_downloader_api:80` |

ç‚¹å‡» **Save hostname**

ä½ çš„å…¬ç½‘åœ°å€å°†æ˜¯ï¼š`https://golf-video-api.ä½ çš„åŸŸå.com`

### æ­¥éª¤ 3ï¼šé…ç½®æœ¬åœ°ç¯å¢ƒ

```bash
cd MyVideoDownloder

# åˆ›å»º .env æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .envï¼Œå¡«å…¥åˆšæ‰å¤åˆ¶çš„ Token
nano .env  # æˆ–ä½¿ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨
```

`.env` æ–‡ä»¶å†…å®¹ï¼š
```env
TUNNEL_TOKEN=eyJhIjoixxxxxä½ çš„å®é™…token
```

### æ­¥éª¤ 4ï¼šä¸€é”®å¯åŠ¨

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x setup_golf_api.sh

# å¯åŠ¨æœåŠ¡
./setup_golf_api.sh
```

æˆ–æ‰‹åŠ¨å¯åŠ¨ï¼š

```bash
docker-compose -f docker-compose.cloudflare.yml up -d --build
```

### æ­¥éª¤ 5ï¼šéªŒè¯éƒ¨ç½²

**æœ¬åœ°æµ‹è¯•ï¼š**
```bash
curl http://localhost:8081/docs
```

**å…¬ç½‘æµ‹è¯•ï¼š**
```bash
curl https://golf-video-api.ä½ çš„åŸŸå.com/docs
```

è®¿é—®æµè§ˆå™¨ï¼š
- ğŸ“ API æ–‡æ¡£ï¼š`https://golf-video-api.ä½ çš„åŸŸå.com/docs`

---

## ğŸ“± é«˜å°”å¤« App é›†æˆ

### API åŸºç¡€ä¿¡æ¯

```
åŸºç¡€ URL: https://golf-video-api.ä½ çš„åŸŸå.com
```

### ä¸»è¦æ¥å£

#### 1. è§†é¢‘è§£æï¼ˆæ··åˆæ¥å£ï¼‰

æ”¯æŒæŠ–éŸ³ã€TikTokã€Bç«™ç­‰å¤šå¹³å°

```bash
POST /api/hybrid/video_data
Content-Type: application/json

{
  "url": "è§†é¢‘åˆ†äº«é“¾æ¥"
}
```

#### 2. ä¸‹è½½æ¥å£

```bash
GET /api/download?url=è§†é¢‘æ–‡ä»¶URL
```

### ç¤ºä¾‹ä»£ç ï¼ˆSwiftï¼‰

```swift
func parseVideoURL(shareURL: String) async throws -> VideoData {
    let url = URL(string: "https://golf-video-api.ä½ çš„åŸŸå.com/api/hybrid/video_data")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    
    let body = ["url": shareURL]
    request.httpBody = try JSONEncoder().encode(body)
    
    let (data, _) = try await URLSession.shared.data(for: request)
    return try JSONDecoder().decode(VideoData.self, from: data)
}
```

---

## ğŸ”§ ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
docker-compose -f docker-compose.cloudflare.yml ps
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.cloudflare.yml logs -f

# ä»… API æ—¥å¿—
docker logs -f golf_video_downloader_api

# ä»… Tunnel æ—¥å¿—
docker logs -f golf_cloudflare_tunnel
```

### é‡å¯æœåŠ¡
```bash
docker-compose -f docker-compose.cloudflare.yml restart
```

### åœæ­¢æœåŠ¡
```bash
docker-compose -f docker-compose.cloudflare.yml down
```

### æ›´æ–°æœåŠ¡
```bash
git pull
docker-compose -f docker-compose.cloudflare.yml up -d --build
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. å¯ç”¨ API Key éªŒè¯

ç¼–è¾‘ `config.yaml`ï¼š

```yaml
API:
  API_Key: "ä½ çš„è‡ªå®šä¹‰å¯†é’¥"
```

App è¯·æ±‚æ—¶éœ€è¦æ·»åŠ  Headerï¼š
```
Authorization: Bearer ä½ çš„è‡ªå®šä¹‰å¯†é’¥
```

### 2. CloudFlare è®¿é—®ç­–ç•¥

1. è¿›å…¥ CloudFlare â†’ **Access** â†’ **Applications**
2. åˆ›å»ºæ–°åº”ç”¨ä¿æŠ¤ä½ çš„ API
3. é…ç½®ï¼š
   - IP ç™½åå•
   - åœ°ç†ä½ç½®é™åˆ¶
   - è¯·æ±‚é¢‘ç‡é™åˆ¶

### 3. é™æµä¿æŠ¤

CloudFlare Dashboard â†’ **Security** â†’ **WAF** â†’ **Rate limiting**

å»ºè®®è§„åˆ™ï¼š
- æ¯ä¸ª IP æ¯åˆ†é’Ÿæœ€å¤š 60 æ¬¡è¯·æ±‚

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å¥åº·æ£€æŸ¥

API è‡ªåŠ¨æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€ï¼Œå¦‚æœå¤±è´¥ä¼šè‡ªåŠ¨é‡å¯

### æ—¥å¿—æ¸…ç†

```bash
# æ¸…ç† 7 å¤©å‰çš„æ—¥å¿—
find logs/ -name "*.log" -mtime +7 -delete
```

### ä¸‹è½½æ–‡ä»¶æ¸…ç†

```bash
# æ¸…ç† 1 å¤©å‰çš„ä¸‹è½½æ–‡ä»¶
find download/ -type f -mtime +1 -delete
```

å»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: Tunnel è¿æ¥å¤±è´¥ï¼Ÿ

```bash
# æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®
docker logs golf_cloudflare_tunnel

# ç¡®è®¤æ˜¾ç¤º "Connection established"
```

### Q: API æ— å“åº”ï¼Ÿ

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep golf

# æŸ¥çœ‹ API æ—¥å¿—
docker logs --tail 50 golf_video_downloader_api

# é‡å¯ API
docker restart golf_video_downloader_api
```

### Q: å…¬ç½‘è®¿é—® 404ï¼Ÿ

1. ç¡®è®¤ CloudFlare Tunnel ä¸­ Service URL æ˜¯ `video_downloader_api:80`
2. æ£€æŸ¥ä¸¤ä¸ªå®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œï¼š
```bash
docker network inspect myvideo_golf_video_net
```

### Q: è§†é¢‘ä¸‹è½½æ…¢ï¼Ÿ

1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. å¢åŠ å¹¶å‘æ•°ï¼ˆç¼–è¾‘ `config.yaml`ï¼‰ï¼š
```yaml
API:
  Max_Workers: 4
```

---

## ğŸ¯ Docker Desktop é…ç½®

### ç¡®ä¿å¼€æœºè‡ªåŠ¨å¯åŠ¨

1. æ‰“å¼€ Docker Desktop
2. **Settings** â†’ **General**
3. âœ… **Start Docker Desktop when you log in**

### èµ„æºé…ç½®å»ºè®®

**Settings** â†’ **Resources**ï¼š

- **CPUs**: 2-4 æ ¸
- **Memory**: 4-8 GB
- **Disk**: è‡³å°‘ 20 GB

---

## ğŸŒ æ”¯æŒçš„å¹³å°

| å¹³å° | çŠ¶æ€ |
|------|------|
| æŠ–éŸ³ (Douyin) | âœ… å®Œå…¨æ”¯æŒ |
| TikTok | âœ… å®Œå…¨æ”¯æŒ |
| å“”å“©å“”å“© | âœ… å®Œå…¨æ”¯æŒ |
| å¿«æ‰‹ | âš ï¸ éœ€é…ç½® |
| YouTube Shorts | âš ï¸ éœ€é…ç½® |

---

## ğŸ“ è·å–å¸®åŠ©

- **API æ–‡æ¡£**: `https://ä½ çš„åŸŸå/docs`
- **é¡¹ç›®ä»“åº“**: [GitHub](https://github.com/Evil0ctal/Douyin_TikTok_Download_API)
- **è¯¦ç»†æ–‡æ¡£**: æŸ¥çœ‹ `setup_cloudflare.md`

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Docker Desktop è¿è¡Œæ­£å¸¸
- [ ] CloudFlare Tunnel å·²åˆ›å»º
- [ ] Public Hostname å·²é…ç½®
- [ ] `.env` æ–‡ä»¶å·²é…ç½® Token
- [ ] æœåŠ¡å·²å¯åŠ¨ï¼ˆ`docker ps` å¯è§ï¼‰
- [ ] æœ¬åœ°å¯è®¿é—® `http://localhost:8081/docs`
- [ ] å…¬ç½‘å¯è®¿é—® `https://ä½ çš„åŸŸå/docs`
- [ ] App æµ‹è¯•è§£æè§†é¢‘æˆåŠŸ

---

## ğŸŠ å®Œæˆï¼

ä½ çš„è§†é¢‘ä¸‹è½½ API ç°åœ¨å·²ç»ï¼š
- âœ… å®‰å…¨æš´éœ²åˆ°å…¬ç½‘
- âœ… è‡ªåŠ¨é‡å¯å’Œå¥åº·æ£€æŸ¥
- âœ… éš Docker Desktop å¼€æœºå¯åŠ¨
- âœ… å‡†å¤‡å¥½ä¾›é«˜å°”å¤« App ä½¿ç”¨

å¼€å§‹åœ¨ä½ çš„ App ä¸­é›†æˆå§ï¼ ğŸŒï¸â€â™‚ï¸

